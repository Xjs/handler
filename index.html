<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <title>Handler by jatronizer</title>
  </head>

  <body>
    <header>
      <div class="inner">
        <h1>Handler</h1>
        <h2>Java instrumentation for easy method routing</h2>
        <a href="https://github.com/jatronizer/handler" class="button"><small>View project on</small>GitHub</a>
      </div>
    </header>

    <div id="content-wrapper">
      <div class="inner clearfix">
        <section id="main-content">
          <h1>Handler</h1>

<p>A java instrumentation library for easy method routing.</p>

<p>It's <a href="https://raw.github.com/jatronizer/handler/master/LICENSE">MIT-licensed</a>.</p>

<h2>What does it do?</h2>

<p>It applies the Handler Pattern - a Design Pattern made for tools. It instruments bytecode (a class seen as <code>[]byte</code>)
The Handler Pattern as supported by this library gives full control over a method's behavior in a class.
It is a design pattern designed for use with bytecode instrumentation.
An interface serves as a configuration file for the instrumentation.</p>

<h2>How do I use it?</h2>

<p>You only declare an interface and point the library at it.</p>

<h2>What can I do with THAT?!?</h2>

<p>When this is applied, you are able to intercept, record, change, redirect or ignore method calls. What could this be used for? Some obvious choices - but only scratching the surface:</p>

<ul>
<li>easy creation of mocks for any objects</li>
<li>lightweight / focused profilers</li>
<li>logging on method calls</li>
<li>opening up rigid and restricting libraries</li>
<li>...</li>
</ul><h2>How... What?!?</h2>

<p>You want to check how often a method <code>charToInt</code> is called on an instance of class <code>Caster</code>.</p>

<div class="highlight"><pre>    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Caster</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="nf">Caster</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">}</span>

        <span class="c1">// we want to instrument this method</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">charToInt</span><span class="o">(</span><span class="kt">char</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">c</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>

<p>To measure the number of calls to <code>charToInt</code> with the Handler Pattern, you create an interface <code>CharToIntHandler</code></p>

<div class="highlight"><pre>    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CharToIntHandler</span> <span class="o">{</span>
        <span class="c1">// the new version of our method</span>
        <span class="kt">int</span> <span class="nf">charToInt</span><span class="o">(</span><span class="n">CharToIntHandler</span> <span class="n">handler</span><span class="o">,</span> <span class="kt">char</span> <span class="n">c</span><span class="o">);</span>

        <span class="c1">// we need this to set our Handler, HandlerInstrumentation will create this</span>
        <span class="kt">void</span> <span class="nf">setCharToIntHandler</span><span class="o">(</span><span class="n">CharToIntHandler</span> <span class="n">handler</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>

<p><code>HandlerInjector</code> injects <code>CharToIntHandler</code> into <code>Caster</code> and reroutes the method calls. <code>Caster</code> now becomes</p>

<div class="highlight"><pre>    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Caster</span> <span class="kd">implements</span> <span class="n">CharToIntHandler</span> <span class="o">{</span>
        <span class="c1">// where the Handler is stored</span>
        <span class="kd">private</span> <span class="n">CharToIntHandler</span> <span class="n">charToIntHandler</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Caster</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">// set to this at initialization so we can safely call methods</span>
            <span class="n">charToIntHandler</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// the original version with a changed signature</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">charToInt</span><span class="o">(</span><span class="n">CharToIntHandler</span> <span class="n">handler</span><span class="o">,</span> <span class="kt">char</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">c</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// all calls end up here and are rerouted to the Handler</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">charToInt</span><span class="o">(</span><span class="kt">char</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">charToIntHandler</span><span class="o">.</span><span class="na">charToInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// we need this to set the Handler without reflection (casting only)</span>
        <span class="kd">public</span> <span class="n">CharToIntHandler</span> <span class="nf">setCharToIntHandler</span><span class="o">(</span><span class="n">CharToIntHandler</span> <span class="n">charToIntHandler</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">charToIntHandler</span> <span class="o">=</span> <span class="n">charToIntHandler</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="k">this</span> <span class="o">:</span> <span class="n">charToIntHandler</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>

<p>Now every instance of <code>Caster</code> is castable to <code>CharToIntHandler</code> at runtime. Given this <code>CharToIntHandler</code> (not thread-safe, but that's up to you)</p>

<div class="highlight"><pre>    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">CallCounter</span> <span class="kd">implements</span> <span class="n">CharToIntHandler</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">calls</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCallCount</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">calls</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">charToInt</span><span class="o">(</span><span class="n">CharToIntHandler</span> <span class="n">handlee</span><span class="o">,</span> <span class="kt">char</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">calls</span><span class="o">++;</span>
            <span class="k">return</span> <span class="n">handlee</span><span class="o">.</span><span class="na">charToInt</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCharToIntHandler</span><span class="o">(</span><span class="n">CharToIntHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// this will never get called on a handler, it's for the handlee</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnsupportedOperationException</span><span class="o">(</span><span class="s">"you can't handle this!"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>

<p>You can get the number of charToInt calls your Caster instance receives:</p>

<div class="highlight"><pre><span class="n">Caster</span> <span class="n">caster</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Caster</span><span class="o">();</span>
<span class="n">CallCounter</span> <span class="n">counter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CallCounter</span><span class="o">();</span>
<span class="n">caster</span><span class="o">.</span><span class="na">charToInt</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="n">assertTrue</span><span class="o">(</span><span class="n">counter</span><span class="o">.</span><span class="na">getCallCount</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">);</span>
<span class="o">((</span><span class="n">CharToIntHandler</span><span class="o">)</span> <span class="n">caster</span><span class="o">).</span><span class="na">setCharToIntHandler</span><span class="o">(</span><span class="n">counter</span><span class="o">);</span>
<span class="n">caster</span><span class="o">.</span><span class="na">charToInt</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="n">assertTrue</span><span class="o">(</span><span class="n">counter</span><span class="o">.</span><span class="na">getCallCount</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span><span class="o">);</span>
<span class="n">caster</span><span class="o">.</span><span class="na">charToInt</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="n">assertTrue</span><span class="o">(</span><span class="n">counter</span><span class="o">.</span><span class="na">getCallCount</span><span class="o">()</span> <span class="o">==</span> <span class="mi">2</span><span class="o">);</span>
</pre></div>
        </section>

        <aside id="sidebar">
          <a href="https://github.com/jatronizer/handler/zipball/master" class="button">
            <small>Download</small>
            .zip file
          </a>
          <a href="https://github.com/jatronizer/handler/tarball/master" class="button">
            <small>Download</small>
            .tar.gz file
          </a>

          <p class="repo-owner"><a href="https://github.com/jatronizer/handler"></a> is maintained by <a href="https://github.com/jatronizer">jatronizer</a>.</p>

          <p>This page was generated by <a href="pages.github.com">GitHub Pages</a> using the Architect theme by <a href="http://twitter.com/jasonlong">Jason Long</a>.</p>
        </aside>
      </div>
    </div>

  
  </body>
</html>